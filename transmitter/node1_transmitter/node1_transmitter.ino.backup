/*
 * Node 1 ESP8266 Transmitter (IMPROVED VERSION)





































































































































































- Power supply specs- LoRa module model number- Photos of your wiring- Serial Monitor output**Still having issues?** Open an issue with:---4. Check [TROUBLESHOOTING.md](TROUBLESHOOTING.md) for detailed help3. If still failing, run `lora_diagnostic.ino`2. Upload the updated `node1_transmitter.ino`1. Update your wiring: Move NSS from **D8 → D4**## Next Steps- ✅ Powered USB hub or 5V/2A adapter- ✅ Breadboard (good quality)- ✅ Quality jumper wires- ✅ Antenna (helical or wire 1/4 wave)- ✅ 100nF ceramic capacitor- ✅ 100µF electrolytic capacitor- ✅ 3.3V LDO regulator (AMS1117-3.3)- ✅ LoRa RA-02 module (correct frequency)If you need to upgrade your setup:## Hardware Shopping List| Initialization timeout | Wrong frequency module || No transmission | Antenna not connected || Intermittent failures | Poor power supply, add capacitor || Boot loop | GPIO15 issue, use D4 instead of D8 || Module not detected | Check power, try different NSS pin ||---------|----------|| Problem | Solution |## Common Issues & Quick Fixes   - Upload and test   - Add retry logic (already in updated sketch)   - Change `#define LORA_SS D8` to `D4`4. **Update Your Code**   - Check initialization messages   - Open Serial Monitor (115200 baud)   - Use `lora_diagnostic.ino`3. **Upload Diagnostic Sketch**   - No shorts between VCC and GND   - Check GND continuity   - Measure VCC with multimeter = 3.3V2. **Power Test**   - Antenna attached   - No crossed wires   - All wires connected1. **Visual Check**## Testing Sequence```     Add 100µF capacitor between VCC & GND     Power: 3.3V @ 150mA minimum                                        [ANT] ← Connect antenna!     [D2]    ─────────────────────────► [DIO0]     [D0]    ─────────────────────────► [RST]     [D4]    ─────────────────────────► [NSS]  ← Changed!     [D5]    ─────────────────────────► [SCK]     [D6]    ─────────────────────────► [MISO]     [D7]    ─────────────────────────► [MOSI]     [GND]   ─────────────────────────► [GND]     [3.3V]  ─────────────────────────► [VCC]          ESP8266 NodeMCU                    LoRa RA-02```## Visual Breadboard Layout```  - Use wrong frequency antenna  - Transmit without antenna (damages module!)❌ Never:  - Proper orientation (vertical)  - Options: helical, wire (1/4 wave = 17.3cm for 433MHz)  - Must have antenna connected!✅ Required:```### 3. **Antenna**```  - Mixed wire gauges  - Bent module pins  - Damaged breadboard rows  - Loose jumper wires❌ Poor connections:  - Secure breadboard connections  - Keep wires short (<15cm)  - Use quality jumper wires  - Solder wires to module pins✅ Good connections:```### 2. **Connection Quality**```  - Use long thin wires for power  - Use 5V (will damage module!)  - Power from ESP8266's 3.3V pin (insufficient current)❌ DON'T:  - Powered USB hub or wall adapter  - Use thick/short power wires  - Add 100µF capacitor near LoRa VCC/GND  - Use dedicated 3.3V power supply✅ DO:```### 1. **Power Supply** (Most Critical!)## Physical Connection Tips```DIO0    → D2 (GPIO4)RST     → D0 (GPIO16)NSS/CS  → D3 (GPIO0)  [⚠️ Must be HIGH during boot]```#### Configuration 3:```DIO0    → D2 (GPIO4)RST     → D0 (GPIO16)NSS/CS  → D1 (GPIO5)```#### Configuration 2:If D4 doesn't work, try these alternatives:### Alternative Configurations- **D4 (GPIO2)** is a better choice for NSS pin- Using it as NSS can cause boot failures- GPIO15 must be pulled LOW during ESP8266 boot**GPIO15 (D8) Boot Issue:**### Why D4 instead of D8?```ANT                    →   Antenna (required!)DIO0                   →   D2 (GPIO4)RST                    →   D0 (GPIO16)NSS/CS                 →   D4 (GPIO2)  ✅ CHANGED FROM D8SCK                    →   D5 (GPIO14)MISO                   →   D6 (GPIO12)MOSI                   →   D7 (GPIO13)GND                    →   GNDVCC                    →   3.3V (⚠️ NOT 5V!)=============================================LoRa RA-02 Module          ESP8266 NodeMCU```### Recommended Configuration (Updated)## Pin Connections for ESP8266 NodeMCU * 
 * Reads alert data from laptop via Serial (115200 baud)
 * Transmits alert packets via LoRa (433 MHz)
 * 
 * Expected Serial input format:
 * EVT:GUNSHOT;CONF:0.91;LAT:27.70;LON:85.33;TS:1735119862\n
 * 
 * Hardware:
 * - ESP8266 (NodeMCU, Wemos D1 Mini, etc.)
 * - LoRa RA-02 (433 MHz)
 * 
 * Pin Connections (DEFAULT):
 * LoRa NSS  -> D4 (GPIO2)   [Changed from D8 to avoid GPIO15 boot issues]
 * LoRa RST  -> D0 (GPIO16)
 * LoRa DIO0 -> D2 (GPIO4)
 * LoRa SCK  -> D5 (GPIO14)  [Hardware SPI]
 * LoRa MISO -> D6 (GPIO12)  [Hardware SPI]
 * LoRa MOSI -> D7 (GPIO13)  [Hardware SPI]
 * 
 * IMPORTANT: Use 3.3V for LoRa module, NOT 5V!
 */

#include <Arduino.h>
#include <SPI.h>
#include <LoRa.h>

// -------- LoRa Configuration --------
// Changed NSS from D8 (GPIO15) to D4 (GPIO2) to avoid boot issues
// GPIO15 must be LOW during boot, which can interfere with LoRa
#define LORA_SS   D4    // NSS pin (was D8)
#define LORA_RST  D0    // Reset pin
#define LORA_DIO0 D2    // DIO0 pin
#define LORA_FREQ 433E6 // 433 MHz (Change to 915E6 for 915 MHz)

// -------- LoRa Parameters --------
#define SPREADING_FACTOR 7    // SF7-SF9 (lower = faster, less range)
#define SIGNAL_BANDWIDTH 125E3 // 125 kHz
#define TX_POWER 17           // 2-20 dBm

// -------- Serial Configuration --------
#define SERIAL_BAUD 115200
#define MAX_PACKET_SIZE 255

// -------- Status LED (built-in) --------
#define LED_PIN LED_BUILTIN

// -------- Variables --------
String incomingData = "";
unsigned long lastPacketTime = 0;
unsigned long packetCount = 0;

void setup() {
  // Initialize Serial
  Serial.begin(SERIAL_BAUD);
  while (!Serial) {
    delay(10);
  }
  
  // Initialize LED
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, HIGH); // LED OFF (active low on most ESP8266)
  
  Serial.println();
  Serial.println("=================================");
  Serial.println("Node 1 - LoRa Transmitter");
  Serial.println("=================================");
  Serial.println();
  Serial.println("Pin Configuration:");
  Serial.print("  NSS/CS: D4 (GPIO");
  Serial.print(LORA_SS);
  Serial.println(")");
  Serial.print("  RST:    D0 (GPIO");
  Serial.print(LORA_RST);
  Serial.println(")");
  Serial.print("  DIO0:   D2 (GPIO");
  Serial.print(LORA_DIO0);
  Serial.println(")");
  Serial.println("  MOSI:   D7 (GPIO13)");
  Serial.println("  MISO:   D6 (GPIO12)");
  Serial.println("  SCK:    D5 (GPIO14)");
  Serial.println();
  
  // Initialize LoRa with improved error handling
  SPI.begin();
  
  // Manual reset sequence for better reliability
  pinMode(LORA_RST, OUTPUT);
  digitalWrite(LORA_RST, LOW);
  delay(10);
  digitalWrite(LORA_RST, HIGH);
  delay(10);
  
  LoRa.setPins(LORA_SS, LORA_RST, LORA_DIO0);
  
  Serial.print("Initializing LoRa at ");
  Serial.print(LORA_FREQ / 1E6);
  Serial.println(" MHz...");
  
  // Try initialization with retry logic
  int retries = 0;
  const int MAX_RETRIES = 5;
  bool loraInitialized = false;
  
  while (retries < MAX_RETRIES && !loraInitialized) {
    if (LoRa.begin(LORA_FREQ)) {
      loraInitialized = true;
      break;
    }
    retries++;
    Serial.print("Retry ");
    Serial.print(retries);
    Serial.print("/");
    Serial.println(MAX_RETRIES);
    delay(500);
  }
  
  if (!loraInitialized) {
    Serial.println();
    Serial.println("[ERROR] LoRa initialization failed after all retries!");
    Serial.println();
    Serial.println("Troubleshooting steps:");
    Serial.println("1. Check wiring (especially NSS -> D4, not D8)");
    Serial.println("2. Verify 3.3V power (NOT 5V!)");
    Serial.println("3. Ensure LoRa module is not damaged");
    Serial.println("4. Check that antenna is connected");
    Serial.println("5. Verify correct frequency module (433 MHz)");
    Serial.println("6. Try running lora_diagnostic.ino for detailed testing");
    Serial.println();
    Serial.println("See TROUBLESHOOTING.md for more help");
    Serial.println();
    while (1) {
      // Blink LED rapidly to indicate error
      digitalWrite(LED_PIN, LOW);
      delay(100);
      digitalWrite(LED_PIN, HIGH);
      delay(100);
    }
  }
  
  Serial.println("[OK] LoRa initialized successfully!");
  Serial.println();
  
  // Configure LoRa parameters
  LoRa.setSpreadingFactor(SPREADING_FACTOR);
  LoRa.setSignalBandwidth(SIGNAL_BANDWIDTH);
  LoRa.setTxPower(TX_POWER);
  LoRa.enableCrc(); // Enable CRC for error detection
  
  Serial.println("[OK] LoRa initialized successfully!");
  Serial.print("Spreading Factor: SF");
  Serial.println(SPREADING_FACTOR);
  Serial.print("Bandwidth: ");
  Serial.print(SIGNAL_BANDWIDTH / 1E3);
  Serial.println(" kHz");
  Serial.print("TX Power: ");
  Serial.print(TX_POWER);
  Serial.println(" dBm");
  Serial.println();
  Serial.println("Waiting for alert data from laptop...");
  Serial.println("Expected format: EVT:TYPE;CONF:0.XX;LAT:XX.XX;LON:XX.XX;TS:XXXXXXX");
  Serial.println("=================================");
  
  // Blink LED to indicate ready
  for (int i = 0; i < 3; i++) {
    digitalWrite(LED_PIN, LOW);
    delay(200);
    digitalWrite(LED_PIN, HIGH);
    delay(200);
  }
}

void loop() {
  // Read data from Serial (laptop)
  while (Serial.available() > 0) {
    char c = Serial.read();
    
    if (c == '\n' || c == '\r') {
      // End of line - process the data
      if (incomingData.length() > 0) {
        processAndTransmit(incomingData);
        incomingData = ""; // Clear buffer
      }
    } else {
      // Add character to buffer
      incomingData += c;
      
      // Prevent buffer overflow
      if (incomingData.length() > MAX_PACKET_SIZE) {
        Serial.println("[WARN] Packet too large, truncating...");
        incomingData = incomingData.substring(0, MAX_PACKET_SIZE);
      }
    }
  }
}

void processAndTransmit(String payload) {
  Serial.println();
  Serial.println("--- New Alert Received ---");
  Serial.print("Payload: ");
  Serial.println(payload);
  Serial.print("Length: ");
  Serial.print(payload.length());
  Serial.println(" bytes");
  
  // Validate payload (basic check)
  if (!validatePayload(payload)) {
    Serial.println("[ERROR] Invalid payload format! Skipping transmission.");
    return;
  }
  
  // Transmit via LoRa
  digitalWrite(LED_PIN, LOW); // LED ON during transmission
  
  Serial.print("Transmitting via LoRa... ");
  unsigned long txStart = millis();
  
  LoRa.beginPacket();
  LoRa.print(payload);
  LoRa.endPacket();
  
  unsigned long txDuration = millis() - txStart;
  
  digitalWrite(LED_PIN, HIGH); // LED OFF
  
  Serial.print("[OK] Sent in ");
  Serial.print(txDuration);
  Serial.println(" ms");
  
  // Update stats
  packetCount++;
  lastPacketTime = millis();
  
  Serial.print("Total packets sent: ");
  Serial.println(packetCount);
  Serial.println("--------------------------");
}

bool validatePayload(String payload) {
  // Basic validation - check if payload contains expected fields
  if (payload.length() < 10) {
    return false;
  }
  
  // Check for key identifiers
  if (payload.indexOf("EVT:") == -1) {
    Serial.println("[WARN] Missing EVT field");
    return false;
  }
  
  if (payload.indexOf("CONF:") == -1) {
    Serial.println("[WARN] Missing CONF field");
    return false;
  }
  
  // Payload seems valid
  return true;
}
